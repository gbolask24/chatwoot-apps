<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Order Lookup</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f7f9fc; color: #333; }
    h2 { margin-bottom: 12px; }

    .card {
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 16px;
      overflow-x: auto;
    }

    .context-info { font-size: 13px; color: #64748b; margin-bottom: 10px; }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #dbe3ef;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    input:focus { border-color:#94a3b8; box-shadow:0 0 0 3px rgba(148,163,184,0.15); }

    .btn-primary {
      width: 100% !important;
      padding: 10px 12px !important;
      background: #2563eb !important;
      color: white !important;
      border: none !important;
      border-radius: 8px !important;
      font-weight: 900 !important;
      cursor: pointer !important;
    }
    .btn-primary:hover { background: #1e4fd6 !important; }
    .btn-primary:disabled { opacity: 0.65; cursor: not-allowed !important; }

    .btn-secondary{
      width:auto !important;
      padding: 10px 12px !important;
      border-radius: 8px !important;
      border: 1px solid #cbd5e1 !important;
      background: #ffffff !important;
      color:#0f172a !important;
      font-weight:900 !important;
      cursor:pointer !important;
      white-space: nowrap !important;
    }
    .btn-secondary:hover{ background:#f8fafc !important; }

    .btn-mini{
      width:auto !important;
      max-width:none !important;
      padding: 8px 10px !important;
      border-radius: 8px !important;
      border: 1px solid #cbd5e1 !important;
      background: #ffffff !important;
      color:#0f172a !important;
      font-weight:900 !important;
      cursor:pointer !important;
      display:inline-flex !important;
      align-items:center !important;
      justify-content:center !important;
      gap:6px !important;
      white-space:nowrap !important;
      line-height: 1 !important;
    }
    .btn-mini:hover{ background:#f8fafc !important; }

    .btn-mini-primary{
      border-color:#1d4ed8 !important;
      background:#2563eb !important;
      color:#fff !important;
    }
    .btn-mini-primary:hover{ background:#1e4fd6 !important; }

    #result button { width: auto !important; }

    .loading { font-size: 14px; color: #64748b; }
    .error { color: #b91c1c; font-size: 14px; }

    .actions-row {
      display:flex;
      gap:10px;
      align-items:center;
    }
    .actions-row input { margin:0; flex: 1; }

    table {
      width: 100%;
      min-width: 980px;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: fixed;
    }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th { background: #f1f5f9; }

    th:nth-child(1), td:nth-child(1) { width: 170px; }
    th:nth-child(2), td:nth-child(2) { width: 160px; }
    th:nth-child(3), td:nth-child(3) { width: 120px; }
    th:nth-child(4), td:nth-child(4) { width: 280px; }
    th:nth-child(5), td:nth-child(5) { width: 200px; }
    th:nth-child(6), td:nth-child(6) { width: 90px; }

    /* IMPORTANT: allow dropdown to overflow outside the table cell */
    td.actions-cell { overflow: visible !important; position: relative; z-index: 5; }

    .click-row { cursor: pointer; }
    .click-row:hover td { background: #f8fafc; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .pill-ok { background: #dcfce7; color:#14532d; }
    .pill-warn { background: #fef9c3; color:#713f12; }
    .pill-bad { background: #fee2e2; color:#7f1d1d; }
    .pill-neutral { background: #e2e8f0; color:#0f172a; }
    .pill-info { background: #dbeafe; color:#1e3a8a; }

    .status-processing { background:#dbeafe; color:#1e3a8a; }
    .status-complete { background:#dcfce7; color:#14532d; }
    .status-canceled, .status-cancelled { background:#fee2e2; color:#7f1d1d; }
    .status-pending, .status-pending_payment, .status-payment_review { background:#fef9c3; color:#713f12; }
    .status-closed { background:#e2e8f0; color:#0f172a; }

    .ship-summary { display:flex; flex-wrap: wrap; gap:6px; align-items:center; }
    .ship-summary .pill { margin-left: 0; }

    /* Dropdown */
    .dd { position: relative; display:inline-block; }
    .dd-btn{
      width:auto !important;
      padding: 6px 10px !important;
      border-radius: 8px !important;
      border: 1px solid #cbd5e1 !important;
      background: #ffffff !important;
      color:#0f172a !important;
      font-weight:900 !important;
      cursor:pointer !important;
      line-height: 1 !important;
    }
    .dd-btn:hover{ background:#f8fafc !important; }

    .dd-menu{
      position:absolute;
      right:0;
      top: 34px;
      min-width: 180px;
      background:#fff;
      border:1px solid #e2e8f0;
      border-radius:10px;
      box-shadow:0 10px 24px rgba(0,0,0,0.12);
      padding: 6px;
      display:none;
      z-index: 9999;
    }
    .dd-menu[data-open="1"]{ display:block; }

    .dd-item{
      width:100% !important;
      display:flex !important;
      justify-content:flex-start !important;
      gap:8px !important;
      padding: 10px 10px !important;
      border-radius:8px !important;
      border:0 !important;
      background:#fff !important;
      color:#0f172a !important;
      font-weight:900 !important;
      cursor:pointer !important;
    }
    .dd-item:hover{ background:#f8fafc !important; }
    .dd-item[disabled]{ opacity:0.5; cursor:not-allowed !important; }

    /* Modal */
    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal-overlay[data-open="1"]{ display:flex; }

    .modal{
      width: min(980px, 100%);
      max-height: min(82vh, 900px);
      overflow:auto;
      background:#fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      border: 1px solid rgba(226,232,240,0.9);
    }

    .modal-head{
      position: sticky;
      top: 0;
      z-index: 2;
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-title{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width:0;
    }
    .modal-title .topline{
      font-weight: 900;
      color:#0f172a;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .modal-title .subline{
      font-size: 12px;
      color:#64748b;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .modal-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .modal-body{ padding: 12px; }

    .details {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      white-space: normal;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .section-title { font-weight: 900; margin: 10px 0 6px; color: #0f172a; }
    .muted { color: #64748b; }

    .list { margin: 0; padding-left: 18px; }
    .list li { margin: 4px 0; }

    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
      table { min-width: 880px; }
    }
  </style>
</head>

<body>

<h2>Order Lookup üîé <span style="font-size:12px;color:#64748b;">v8.1</span></h2>

<div class="card">
  <div id="contextInfo" class="context-info"></div>

  <div class="actions-row">
    <input type="text" id="searchInput" placeholder="Enter customer email or order number" />
    <button type="button" class="btn-secondary" onclick="clearResults()">Clear</button>
  </div>

  <div style="height:10px;"></div>
  <button id="searchBtn" class="btn-primary" onclick="searchOrders()">Search</button>

  <div style="margin-top:10px; font-size:12px; color:#64748b;">
    Magento Admin link requires you to be logged into Magento Admin in the same browser session.
  </div>
</div>

<div id="result"></div>

<!-- Modal -->
<div id="detailsOverlay" class="modal-overlay" data-open="0" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <div class="modal-head">
      <div class="modal-title">
        <div class="topline" id="modalTopLine">Order details</div>
        <div class="subline" id="modalSubLine"></div>
      </div>
      <div class="modal-actions">
        <button id="modalInvoiceBtn" type="button" class="btn-mini btn-mini-primary" style="display:none;">Send Invoice</button>
        <button id="modalMagentoBtn" type="button" class="btn-mini" style="display:none;">Open Magento</button>
        <button id="modalDhlBtn" type="button" class="btn-mini" style="display:none;">Open DHL</button>
        <button type="button" class="btn-mini" onclick="closeDetailsModal()">Close ‚úï</button>
      </div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
  const WEBHOOK_URL = "https://n8n.the2gogroup.cloud/webhook/order-lookup";
  const INVOICE_WEBHOOK_URL = "https://n8n.the2gogroup.cloud/webhook/Invoice-generator";

  const MAGENTO_ADMIN_BASE_URL = "https://www.electrical2go.co.uk";
  const MAGENTO_ADMIN_FRONTNAME = "phaseadmin";
  const MAGENTO_ORDER_VIEW_PATH = "/sales/order/view/order_id/";
  const OPEN_NEW_TAB = true;

  // ‚úÖ Gatekeeping: only allow agent id 1
  const ALLOWED_AGENT_IDS = new Set([1]);
  let CURRENT_AGENT = null;

  let CHATWOOT_CONTEXT = { conversation_id:null, contact_id:null, inbox_id:null, contact_email:null };

  const ORDER_CACHE = [];
  const DETAILS_CACHE = [];
  const INVOICE_LOADING = {};

  function isAuthorizedAgent() {
    return !!(CURRENT_AGENT && ALLOWED_AGENT_IDS.has(Number(CURRENT_AGENT.id)));
  }

  function renderAccessDenied() {
  const name = CURRENT_AGENT?.name ? escapeHtml(CURRENT_AGENT.name) : "Hey";
  document.body.innerHTML = `
    <div class="card" style="text-align:center; padding:22px;">
      <div style="font-size:34px; line-height:1; margin-bottom:10px;">üë®‚Äçüç≥üî•</div>
      <h2 style="margin:0 0 8px;">Coming soon‚Ä¶ we‚Äôre cooking</h2>
      <div class="context-info" style="margin:0 auto; max-width:520px;">
        ${name}, this tool isn‚Äôt available for your account yet.
        <br/>We‚Äôre polishing it up ‚Äî check back soon.
      </div>
      <div style="margin-top:14px; font-size:12px; color:#64748b;">
        Tip: If you think you should have access, ask your team manager for early access.
      </div>
    </div>
  `;
}

  function escapeHtml(value) {
    return String(value ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function money(amount, currency) {
    const n = (amount === null || amount === undefined || amount === "") ? null : Number(amount);
    if (Number.isFinite(n)) {
      const symbol = currency === "GBP" ? "¬£" : (currency ? currency + " " : "");
      return symbol + n.toFixed(2);
    }
    return "‚Äî";
  }

  function fmtDate(s) { return s ? String(s) : "‚Äî"; }
  function safeNum(v, fallback = 0) { const n = Number(v); return Number.isFinite(n) ? n : fallback; }

  function buildFallbackDhlUrl(trackNo) {
    const t = String(trackNo || "").trim();
    if (!t) return "";
    return `https://track.dhlparcel.co.uk/?nav=1&sn=${encodeURIComponent(t)}`;
  }

  function buildMagentoAdminOrderUrl(entityId) {
    const id = String(entityId ?? "").trim();
    const base = String(MAGENTO_ADMIN_BASE_URL || "").replace(/\/+$/, "");
    const front = String(MAGENTO_ADMIN_FRONTNAME || "").replace(/^\/+|\/+$/g, "");
    if (!id || !base || !front) return "";
    return base + "/" + front + MAGENTO_ORDER_VIEW_PATH + encodeURIComponent(id);
  }

  function openUrl(url) {
    if (!url) return;
    if (OPEN_NEW_TAB) window.open(url, "_blank", "noopener,noreferrer");
    else window.location.href = url;
  }

  function canSendInvoice(status) {
    const s = String(status || "").toLowerCase().trim();
    if (!s) return false;
    if (s.includes("cancel")) return false;
    if (s.includes("pending_payment")) return false;
    if (s.includes("pending payment")) return false;
    if (s.includes("payment_review")) return false;
    if (s === "pending") return false;
    return true;
  }

  function orderStatusPillClass(status) {
    const s = String(status || "").toLowerCase().trim();
    if (!s) return "pill-neutral";
    if (s === "processing") return "status-processing";
    if (s === "complete") return "status-complete";
    if (s === "closed") return "status-closed";
    if (s.includes("cancel")) return "status-canceled";
    if (s.includes("pending") || s.includes("payment_review")) return "status-pending";
    return "pill-neutral";
  }

  function buildFulfilmentSummary(o) {
    const products = Array.isArray(o?.products) ? o.products : [];
    const shipments = Array.isArray(o?.shipments) ? o.shipments : [];

    const shippedQty = products.reduce((sum, p) => sum + safeNum(p.qty_shipped, 0), 0);
    const orderedQty = products.reduce((sum, p) => sum + safeNum(p.qty_ordered, 0), 0);

    const isFullyShipped = orderedQty > 0 ? shippedQty >= orderedQty : shipments.length > 0;
    const hasTracking = shipments.some(sh => Array.isArray(sh.tracking) && sh.tracking.length > 0);

    const qtyPill = orderedQty > 0
      ? `<span class="pill pill-info">Qty ${escapeHtml(shippedQty)}/${escapeHtml(orderedQty)}</span>`
      : `<span class="pill pill-neutral">Qty ‚Äî</span>`;

    const shippedPill = isFullyShipped
      ? `<span class="pill pill-ok">Shipped</span>`
      : `<span class="pill pill-warn">Not shipped</span>`;

    const trackingPill = hasTracking
      ? `<span class="pill pill-neutral">Tracking</span>`
      : `<span class="pill pill-warn">No tracking</span>`;

    return `<div class="ship-summary">${shippedPill}${qtyPill}${trackingPill}</div>`;
  }

  function computeOrderDhlUrl(order) {
    const shipments = Array.isArray(order?.shipments) ? order.shipments : [];
    for (const sh of shipments) {
      const tracking = Array.isArray(sh?.tracking) ? sh.tracking : [];
      for (const t of tracking) {
        const url = t?.service_url || t?.serviceUrl;
        const trackNo = t?.track_number || t?.trackingNumber;
        const fallback = buildFallbackDhlUrl(trackNo);
        if (url) return url;
        if (fallback) return fallback;
      }
    }
    return "";
  }

  // ‚úÖ click outside closes dropdown (without instant-close)
  function closeAllDropdowns() {
    document.querySelectorAll(".dd-menu").forEach(m => m.setAttribute("data-open", "0"));
  }

  document.addEventListener("click", (e) => {
    const inside = e.target && e.target.closest && e.target.closest(".dd");
    if (!inside) closeAllDropdowns();
  });

  function toggleDropdown(idx) {
    const menu = document.getElementById("dd_" + idx);
    if (!menu) return;
    const open = menu.getAttribute("data-open") === "1";
    closeAllDropdowns();
    menu.setAttribute("data-open", open ? "0" : "1");
  }

  function clearResults() {
    const el = document.getElementById("result");
    if (el) el.innerHTML = "";
    const input = document.getElementById("searchInput");
    if (input) input.focus();
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const active = document.activeElement;
      if (active && active.id === "searchInput") searchOrders();
    }
    if (e.key === "Escape") closeDetailsModal();
  });

  function isJSONValid(str) {
    if (typeof str !== "string") return false;
    try { JSON.parse(str); return true; } catch { return false; }
  }

  function extractEmail(payload) {
    return (
      payload?.data?.contact?.email ||
      payload?.data?.conversation?.meta?.sender?.email ||
      payload?.data?.conversation?.messages?.[0]?.sender?.email ||
      ""
    );
  }

  window.addEventListener("message", function (event) {
    if (!isJSONValid(event.data)) return;
    const payload = JSON.parse(event.data);
    if (payload?.event !== "appContext") return;

    // ‚úÖ read currentAgent first for gating
    CURRENT_AGENT = payload?.data?.currentAgent || null;

    // ‚úÖ gate: allow only agent id 1
    if (!isAuthorizedAgent()) {
      renderAccessDenied();
      return;
    }

    CHATWOOT_CONTEXT = {
      conversation_id: payload?.data?.conversation?.id ?? null,
      contact_id: payload?.data?.contact?.id ?? null,
      inbox_id: payload?.data?.conversation?.inbox_id ?? null,
      contact_email: extractEmail(payload) || null
    };

    const input = document.getElementById("searchInput");
    const contextInfo = document.getElementById("contextInfo");

    if (CHATWOOT_CONTEXT.contact_email) {
      input.value = CHATWOOT_CONTEXT.contact_email;
      contextInfo.innerHTML = "Prefilled from contact: <strong>" + escapeHtml(CHATWOOT_CONTEXT.contact_email) + "</strong>";
      searchOrders();
    } else {
      contextInfo.innerHTML = "No email found on contact.";
    }
  });

  window.addEventListener("load", function () {
    if (window.parent) window.parent.postMessage("chatwoot-dashboard-app:fetch-info", "*");
  });

  function renderProducts(products, currency) {
    if (!Array.isArray(products) || products.length === 0) return `<div class="muted">No products returned for this order.</div>`;
    return `
      <ul class="list">
        ${products.map(p => `
          <li>
            <strong>${escapeHtml(p.name || "‚Äî")}</strong>
            <span class="muted">(${escapeHtml(p.sku || "‚Äî")})</span>
            <span class="muted">¬∑ Qty: ${escapeHtml(p.qty_shipped ?? 0)} / ${escapeHtml(p.qty_ordered ?? "‚Äî")}</span>
            <span class="muted">¬∑ ${escapeHtml(money(p.price, currency))}</span>
          </li>
        `).join("")}
      </ul>
    `;
  }

  function renderShipments(shipments) {
    if (!Array.isArray(shipments) || shipments.length === 0) return `<div class="muted">No shipments yet.</div>`;
    return shipments.map((s) => {
      const tracking = Array.isArray(s.tracking) ? s.tracking : [];
      const firstT = tracking[0] || null;
      const tNo = firstT?.track_number || firstT?.trackingNumber || "";
      const url = firstT?.service_url || firstT?.serviceUrl || buildFallbackDhlUrl(tNo);

      return `
        <div class="details" style="margin-top:10px;">
          <div><strong>Shipment</strong> <span class="pill pill-neutral">${escapeHtml(s.shipment_increment_id || "‚Äî")}</span></div>
          <div class="muted">Created: ${escapeHtml(fmtDate(s.created_at))} ¬∑ Qty: ${escapeHtml(s.total_qty ?? "‚Äî")}</div>
          <div style="margin-top:6px;">
            ${tNo ? `<span class="pill pill-neutral mono">${escapeHtml(tNo)}</span>` : `<span class="pill pill-warn">No tracking</span>`}
            ${url ? `<a style="margin-left:8px; color:#2563eb; text-decoration:none;" href="${escapeHtml(url)}" target="_blank" rel="noopener">Open DHL</a>` : ``}
          </div>
        </div>
      `;
    }).join("");
  }

  function renderNotes(comments) {
    if (!Array.isArray(comments) || comments.length === 0) return `<div class="muted">No notes returned for this order.</div>`;
    const sorted = comments.slice().sort((a,b) => String(b.created_at||"").localeCompare(String(a.created_at||"")));
    const list = sorted.map(c => {
      const note = c.comment || c.comment_text || "";
      if (!note) return "";
      return `
        <li>
          <span class="muted">${escapeHtml(c.created_at || "‚Äî")}</span>
          <span class="pill pill-neutral">${escapeHtml(c.status || "‚Äî")}</span><br/>
          ${escapeHtml(note)}
        </li>
      `;
    }).join("");
    return list ? `<ul class="list">${list}</ul>` : `<div class="muted">No visible notes.</div>`;
  }

  function openDetailsModal(idx) {
    const o = ORDER_CACHE[idx];
    if (!o) return;

    const overlay = document.getElementById("detailsOverlay");
    overlay.setAttribute("data-open", "1");

    document.getElementById("modalTopLine").textContent = "Order " + (o?.order?.increment_id || "‚Äî");
    document.getElementById("modalSubLine").textContent =
      (o?.order?.created_at ? ("Created: " + o.order.created_at) : "") +
      (o?.customer?.email ? (" ‚Ä¢ " + o.customer.email) : "");

    const magBtn = document.getElementById("modalMagentoBtn");
    const dhlBtn = document.getElementById("modalDhlBtn");
    const invBtn = document.getElementById("modalInvoiceBtn");

    const magUrl = buildMagentoAdminOrderUrl(o?.order?.entity_id);
    const dhlUrl = computeOrderDhlUrl(o);
    const status = o?.order?.status || o?.order?.state || "";
    const canInvoice = canSendInvoice(status);

    if (magUrl) { magBtn.style.display="inline-flex"; magBtn.onclick=()=>openUrl(magUrl); }
    else { magBtn.style.display="none"; magBtn.onclick=null; }

    if (dhlUrl) { dhlBtn.style.display="inline-flex"; dhlBtn.onclick=()=>openUrl(dhlUrl); }
    else { dhlBtn.style.display="none"; dhlBtn.onclick=null; }

    if (canInvoice) {
      invBtn.style.display="inline-flex";
      invBtn.textContent = INVOICE_LOADING[idx] ? "Sending..." : "Send Invoice";
      invBtn.disabled = !!INVOICE_LOADING[idx];
      invBtn.onclick = ()=>sendInvoice(idx);
    } else {
      invBtn.style.display="none";
      invBtn.onclick=null;
    }

    document.getElementById("modalBody").innerHTML = DETAILS_CACHE[idx] || "<div class='muted'>No details available.</div>";
  }

  function closeDetailsModal() {
    const overlay = document.getElementById("detailsOverlay");
    if (overlay) overlay.setAttribute("data-open", "0");
    const body = document.getElementById("modalBody");
    if (body) body.innerHTML = "";
  }

  document.getElementById("detailsOverlay").addEventListener("click", (e) => {
    if (e.target && e.target.id === "detailsOverlay") closeDetailsModal();
  });

  async function sendInvoice(idx) {
    if (!isAuthorizedAgent()) { alert("Access restricted."); return; }

    const o = ORDER_CACHE[idx];
    if (!o) return;
    const status = o?.order?.status || o?.order?.state || "";
    if (!canSendInvoice(status)) return;

    INVOICE_LOADING[idx] = true;
    repaintDropdownRow(idx);
    if (document.getElementById("detailsOverlay").getAttribute("data-open") === "1") openDetailsModal(idx);

    try {
      const payload = {
        source: "chatwoot-order-lookup",
        order: {
          entity_id: o?.order?.entity_id ?? null,
          increment_id: o?.order?.increment_id ?? null,
          created_at: o?.order?.created_at ?? null,
          currency: o?.order?.currency || o?.totals?.currency || "GBP",
          grand_total: o?.order?.grand_total ?? o?.totals?.grand_total ?? null,
          status: status
        },
        customer: {
          email: o?.customer?.email || null,
          name: o?.customer?.name || null,
          is_guest: o?.customer?.is_guest ?? null
        },
        chatwoot: {
          conversation_id: CHATWOOT_CONTEXT.conversation_id,
          contact_id: CHATWOOT_CONTEXT.contact_id,
          inbox_id: CHATWOOT_CONTEXT.inbox_id,
          contact_email: CHATWOOT_CONTEXT.contact_email
        },
        meta: {
          requested_at: new Date().toISOString(),
          app_version: "v8.1",
          current_agent: CURRENT_AGENT
        }
      };

      const res = await fetch(INVOICE_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("Invoice workflow failed");
      alert("Invoice workflow triggered ‚úÖ");
    } catch (e) {
      alert("Invoice error: " + (e?.message || "Unknown error"));
    } finally {
      INVOICE_LOADING[idx] = false;
      repaintDropdownRow(idx);
      if (document.getElementById("detailsOverlay").getAttribute("data-open") === "1") openDetailsModal(idx);
    }
  }

  function rowDropdownHtml(idx, canInvoice) {
    const busy = !!INVOICE_LOADING[idx];
    if (!canInvoice) {
      return `<div class="dd-menu" id="dd_${idx}" data-open="0" onclick="event.stopPropagation();">
        <button class="dd-item" disabled title="Invoice disabled for this order status">Send Invoice</button>
      </div>`;
    }
    return `<div class="dd-menu" id="dd_${idx}" data-open="0" onclick="event.stopPropagation();">
      <button class="dd-item" ${busy ? "disabled" : ""} onclick="event.stopPropagation(); sendInvoice(${idx});">
        ${busy ? "Sending..." : "Send Invoice"}
      </button>
    </div>`;
  }

  function repaintDropdownRow(idx) {
    const holder = document.getElementById("ddHolder_" + idx);
    if (!holder) return;
    const o = ORDER_CACHE[idx];
    const status = o?.order?.status || o?.order?.state || "";
    const canInvoice = canSendInvoice(status);

    holder.innerHTML = `
      <div class="dd" onclick="event.stopPropagation();">
        <button type="button" class="dd-btn" onclick="event.stopPropagation(); toggleDropdown(${idx});">‚ãØ</button>
        ${rowDropdownHtml(idx, canInvoice)}
      </div>
    `;
  }

  function normaliseResponse(data) {
    const root = Array.isArray(data) ? data[0] : data;
    return Array.isArray(root?.orders) ? root.orders : [];
  }

  async function searchOrders() {
    if (!isAuthorizedAgent()) {
      const resultDiv = document.getElementById("result");
      if (resultDiv) resultDiv.innerHTML = "<p class='error'>Access restricted.</p>";
      return;
    }

    const input = document.getElementById("searchInput").value.trim();
    const resultDiv = document.getElementById("result");
    const btn = document.getElementById("searchBtn");

    if (!input) { resultDiv.innerHTML = "<p class='error'>Please enter an email or order number.</p>"; return; }

    resultDiv.innerHTML = "<p class='loading'>Loading orders...</p>";
    btn.disabled = true;

    try {
      const response = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: input })
      });

      if (!response.ok) throw new Error("Server error");
      const data = await response.json();
      const orders = normaliseResponse(data);

      if (!orders.length) { resultDiv.innerHTML = "<p>No orders found.</p>"; return; }

      ORDER_CACHE.length = 0;
      DETAILS_CACHE.length = 0;

      let html = `
        <div class="card">
          <table>
            <thead>
              <tr>
                <th>Order #</th>
                <th>Status</th>
                <th>Total</th>
                <th>Fulfilment</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

      orders.forEach((o, idx) => {
        ORDER_CACHE[idx] = o;

        const currency = o?.order?.currency || o?.totals?.currency || "GBP";
        const totalVal = o?.order?.grand_total ?? o?.totals?.grand_total ?? null;

        const status = o?.order?.status || o?.order?.state || "‚Äî";
        const statusClass = orderStatusPillClass(status);

        const custType = (o?.customer?.is_guest === 1 || o?.customer?.is_guest === true) ? "Guest" : "Account";
        const detailsHtml = `
          <div class="details">
            <div class="grid">
              <div>
                <div><strong>Customer</strong> <span class="pill pill-neutral">${escapeHtml(custType)}</span></div>
                <div class="muted">${escapeHtml((o?.customer?.first_name ? (o.customer.first_name + " " + (o.customer.last_name || "")) : (o?.customer?.name || "‚Äî")))}</div>
                <div class="muted">${escapeHtml(o?.customer?.email || "‚Äî")}</div>
              </div>
              <div>
                <div><strong>Shipping</strong></div>
                <div class="muted">${escapeHtml(o?.order?.shipping_description || "‚Äî")}</div>
              </div>
            </div>

            <div class="section-title">Totals</div>
            <div class="muted">Grand: <strong>${escapeHtml(money(totalVal, currency))}</strong></div>

            <div class="section-title">Products</div>
            ${renderProducts(o.products, currency)}

            <div class="section-title">Shipments & Tracking</div>
            ${renderShipments(o.shipments)}

            <div class="section-title">Notes / History</div>
            ${renderNotes(o.comments)}
          </div>
        `;
        DETAILS_CACHE[idx] = detailsHtml;

        html += `
          <tr class="click-row" onclick="openDetailsModal(${idx});">
            <td class="mono">${escapeHtml(o?.order?.increment_id || "‚Äî")}</td>
            <td><span class="pill ${escapeHtml(statusClass)}">${escapeHtml(status)}</span></td>
            <td>${escapeHtml(money(totalVal, currency))}</td>
            <td>${buildFulfilmentSummary(o)}</td>
            <td>${escapeHtml(fmtDate(o?.order?.created_at))}</td>
            <td class="actions-cell" id="ddHolder_${idx}" onclick="event.stopPropagation();">
              <div class="dd" onclick="event.stopPropagation();">
                <button type="button" class="dd-btn" onclick="event.stopPropagation(); toggleDropdown(${idx});">‚ãØ</button>
                ${rowDropdownHtml(idx, canSendInvoice(status))}
              </div>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table></div>`;
      resultDiv.innerHTML = html;

    } catch (e) {
      resultDiv.innerHTML = "<p class='error'>Error fetching orders.</p>";
    } finally {
      btn.disabled = false;
    }
  }
</script>

</body>
</html>
